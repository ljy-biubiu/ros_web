<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <script type="text/javascript"
    src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script src="../js/roslibjs/roslib.js"></script>
  <script src="../js/design/WEB_PARAM.js"></script>
  <script src="../js/diary/demo.json"></script>

  <link rel="stylesheet" type="text/css" href="../css/style.css">


  <style>
    .camera {
      float: middle;
      margin: 50px;
      position: absolute;
      left: 50px;
      top: 300px;
    }
  </style>
  <script type="text/javascript" type="text/javascript">


    var aa = window.localStorage.getItem('/home/ljy/dev/catkin_wx/src/cti_data_viewer/cti_www/www/license.js'); //读存储的数据
    var aaObj = JSON.parse(aa); //将JSON字符串转化成JSON对象方便读取
    var LICENSE = aaObj.license;
    var IP_PORT = aaObj.ip_port;

    // Connecting to ROS
    var ros = new ROSLIB.Ros({
      url: IP_PORT
    });

    var color = '#99bebe ';
    var style;

    function createStyle() {
      style = document.createElement('style');
      style.type = 'text/css';
    }
    function changeBackgroundColor() {
      if (!style.parentNode) document.head.appendChild(style);
    }
    function changeColor() {
      var color = "yellow|green|blue";
      color = color.split("|");
      document.getElementById("connect_status").style.color = color[parseInt(Math.random() * color.length)];
    }
    setInterval("changeColor()", 500);
    createStyle();
    changeBackgroundColor();

    //判断是否连接成功并输出相应的提示消息到web控制台
    ros.on('connection', function () {
      document.getElementById("connect_status").innerHTML = ('服务器状态（正常）');
      style.innerHTML = 'body {background-color: #bebfc0 ;}';
    });

    ros.on('error', function (error) {
      document.getElementById("connect_status").innerHTML = ('服务器状态（错误）');
      style.innerHTML = 'body {background-color: #4f5257  ;}';
    });

    ros.on('close', function () {
      document.getElementById("connect_status").innerHTML = ('服务器状态（关闭）');
      style.innerHTML = 'body {background-color: #4f5257  ;}';
      alert("服务器连接中断，请检查wifi状态，并刷新当前页面");
    });



    ////////////////////////////////////////////////////////

    ///////////////////////////////////////////////////
    //车辆GPS高度获取
    var vehicle_altitude_position; 
    // // Subscribing to a Topic
    // var listener = new ROSLIB.Topic({
    //   ros: ros,
    //   name: '/cti/rosweb/state',
    //   messageType: 'std_msgs/String'
    // });

    // listener.subscribe(function (message) {
    //   var jsonObj = window.JSON.parse(message.data);
    //   vehicle_altitude_position = jsonObj.altitude.toFixed(3);
    // });

    // Subscribing to a Topic
    var listener = new ROSLIB.Topic({
      ros: ros,
      name: '/base_link_pose',
      messageType: 'geometry_msgs/PoseStamped'
    });

    listener.subscribe(function (message) {
      //var jsonObj = window.JSON.parse(message.data);
      vehicle_altitude_position = message.pose.position.z;
    });


    var NavRelocate_head = new ROSLIB.Message({
      id: "1",
      robot_id: "1",
      coopMode: 1,
      command_type: "MOVE",
      command_state: "PENDING",
      stamp: 0
    });//创建一个message

    var position_Point = new ROSLIB.Message({
      x: 0,
      y: 0,
      z: 0
    });//创建一个message

    var position_Quaternion = new ROSLIB.Message({
      x: 0,
      y: 0,
      z: 0,
      w: 0
    });//创建一个message

    var geometry_msgs_Pos_data = new ROSLIB.Message({
      position: position_Point,
      orientation: position_Quaternion
    });//创建一个message


    // var NavRelocate_data = new ROSLIB.Message({
    //   nav_header: NavRelocate_head,
    //   latitude: 0,
    //   longitude: 0,
    //   altitude: 0,
    //   direction: 0,
    //   map_name: "",
    //   pose: geometry_msgs_Pos_data
    // });//创建一个message

    // function send_navRelocate(x, y, z) {
    //   //command.data = message;
    //   NavRelocate_data.pose.position.x = x;
    //   NavRelocate_data.pose.position.y = y;
    //   NavRelocate_data.pose.position.z = z;
    //   navRelocate_pub.publish(NavRelocate_data);//发布消息
    // }


    // Publishing a Topic
    var Nav_rblit_gps_pub = new ROSLIB.Topic({
      ros: ros,
      name: '/rblite/navdelivery',
      messageType: 'cti_rblite_msgs/NavDelivery'
    });

    var Nav_rblit_gps_data = new ROSLIB.Message({
      nav_header: NavRelocate_head,
      waypoint_id: "1",
      pose: geometry_msgs_Pos_data
    });//创建一个message

    var cnt = 1;
    function send_vehicle_position(y, x, z) {
      //command.data = message;
      Nav_rblit_gps_data.nav_header.command_type = "MOVE";
      cnt++;
      Nav_rblit_gps_data.nav_header.id = cnt.toString();
      // Nav_rblit_gps_data.pose.position.x = x;
      // Nav_rblit_gps_data.pose.position.y = y;
      // Nav_rblit_gps_data.pose.position.z = z;
      Nav_rblit_gps_data.latitude = x;
      Nav_rblit_gps_data.longitude = y;
      Nav_rblit_gps_data.altitude = vehicle_altitude_position * 1;//zheli!!!!
      
      //alert("lat:"+x+" lon:"+y);
      //Nav_rblit_gps_data.altitude = -5;//zheli!!!!
      Nav_rblit_gps_pub.publish(Nav_rblit_gps_data);//发布消息
    }

    // Publishing a Topic
    var Nav_gps_array_pub = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/web/vehicleRouteGps',
      messageType: 'cti_msgs/GnssArray'
    });

    var header = new ROSLIB.Message({
      nav_header: NavRelocate_head,
      pose: geometry_msgs_Pos_data
    });//创建一个message

    // var NavSatFix_GPS_HEARER = new ROSLIB.Message({
    //   frame_id: "wakaka"
    // });//创建一个message

    // var NavSatFix_GPS = new ROSLIB.Message({
    //   header:NavSatFix_GPS_HEARER,
    //   latitude: 0,
    //   longitude: 0,
    //   altitude: 0
    // });//创建一个message

    var NavSatFix_GPS_Array = new ROSLIB.Message({
      datas: []
    });//创建一个message





    ///////////////////////////////////////////////////////
    var GPS = {
      PI: 3.14159265358979324,
      x_pi: 3.14159265358979324 * 3000.0 / 180.0,

      transformLat: function (x, y) {
        var ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x))
        ret += (20.0 * Math.sin(6.0 * x * this.PI) + 20.0 * Math.sin(2.0 * x * this.PI)) * 2.0 / 3.0
        ret += (20.0 * Math.sin(y * this.PI) + 40.0 * Math.sin(y / 3.0 * this.PI)) * 2.0 / 3.0
        ret += (160.0 * Math.sin(y / 12.0 * this.PI) + 320 * Math.sin(y * this.PI / 30.0)) * 2.0 / 3.0
        return ret
      },
      transformLon: function (x, y) {
        var ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x))
        ret += (20.0 * Math.sin(6.0 * x * this.PI) + 20.0 * Math.sin(2.0 * x * this.PI)) * 2.0 / 3.0
        ret += (20.0 * Math.sin(x * this.PI) + 40.0 * Math.sin(x / 3.0 * this.PI)) * 2.0 / 3.0
        ret += (150.0 * Math.sin(x / 12.0 * this.PI) + 300.0 * Math.sin(x / 30.0 * this.PI)) * 2.0 / 3.0
        return ret
      },
      // 坐标转换
      delta: function (lat, lon) {
        var a = 6378245.0 //  a: 卫星椭球坐标投影到平面地图坐标系的投影因子。
        var ee = 0.00669342162296594323 //  ee: 椭球的偏心率。
        var dLat = this.transformLat(lon - 105.0, lat - 35.0)
        var dLon = this.transformLon(lon - 105.0, lat - 35.0)
        var radLat = lat / 180.0 * this.PI
        var magic = Math.sin(radLat)
        magic = 1 - ee * magic * magic
        var sqrtMagic = Math.sqrt(magic)
        dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * this.PI)
        dLon = (dLon * 180.0) / (a / sqrtMagic * Math.cos(radLat) * this.PI)
        return { 'lat': dLat, 'lon': dLon }
      },
      // 判断是否为国外坐标
      outOfChina: function (lat, lon) {
        if (lon < 72.004 || lon > 137.8347) { return true }
        if (lat < 0.8293 || lat > 55.8271) { return true }
        return false
      },
      // GPS---高德
      gcj_encrypt: function (wgsLat, wgsLon) {
        if (this.outOfChina(wgsLat, wgsLon)) { return { 'lat': wgsLat, 'lon': wgsLon } }

        var d = this.delta(wgsLat, wgsLon)
        return { 'lat': wgsLat + d.lat, 'lon': wgsLon + d.lon }
      }
    }

    //export default GPS

    // Connecting to ROS

    function getLocation() {
      if (navigator.geolocation) {
	      //alert("ppppppppppp");
        navigator.geolocation.getCurrentPosition(showPosition, showError, options = {
             enableHighAccuracy: true,//boolean 是否要求高精度的地理信息
              timeout: 5000,
                maximumAge: 0});
      } else {
        alert("浏览器不支持地理定位。");
      }
    }

    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("定位失败,用户拒绝请求地理定位");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("定位失败,位置信息是不可用");
          break;
        case error.TIMEOUT:
          alert("定位失败,请求获取用户位置超时");
          break;
        case error.UNKNOWN_ERROR:
          alert("定位失败,定位系统失效");
          break;
      }
    }

    var lat;
    var lag;
    function showPosition(position) {
      lat = position.coords.latitude; //纬度 
      lag = position.coords.longitude; //经度 
      alert("世界纬度:"+lat + "世界经度:" + lag);
      //alert('纬度:' + lat + ',经度:' + lag);
      const mark = GPS.gcj_encrypt(
        Number(lat),
        Number(lag)
      )
      //alert("高德纬度:"+mark.lat + "高德经度:" + mark.lon);//高德坐标系
      //send_vehicle_position(mark.lon, mark.lat, 999);
      send_vehicle_position( lag, lat, 999);

    }
    ////////////////////////////////////////////////////////////////////记录gps array
    function getLocation_for_gps_array() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition_for_gps_array, showError, options = {
             enableHighAccuracy: true,//boolean 是否要求高精度的地理信息
              timeout: 5000,
                maximumAge: 0});
      } else {
        alert("浏览器不支持地理定位。");
      }
    }


    var ints=1;
    var lat_;
    var lag_;
    var gps_data_array = [];
    var mark2;
    var saver_sum_diary;
    
    function showPosition_for_gps_array(position) {
      lat_ = position.coords.latitude; //纬度 
      lag_ = position.coords.longitude; //经度 


      ////////////////


      // alert("世界纬度:"+lat_ + "世界经度:" + lag_);
      //alert('纬度:' + lat + ',经度:' + lag);
      mark2 = GPS.gcj_encrypt(
        Number(lat_),
        Number(lag_)
      )
      //alert("高德纬度:"+mark.lat + "高德经度:" + mark.lon);//高德坐标系

      var NavSatFix_GPS_HEARER = new ROSLIB.Message({
      frame_id: ""
      });//创建一个message

      var NavSatFix_GPS = new ROSLIB.Message({
      header:NavSatFix_GPS_HEARER,
      latitude: 0,
      longitude: 0,
      altitude: 0
      });//创建一个message

      if (!isNaN(mark2.lat)) {
        console.log(mark2.lat);
        NavSatFix_GPS.latitude = lat_;
        NavSatFix_GPS.longitude = lag_;
        NavSatFix_GPS.altitude = vehicle_altitude_position * 1;
        console.log(" lat:"+ lat_  +" lon:"+ lag_ );
	      alert(" lat:"+ lat_  +" lon:"+ lag_ );

        var tObj = document.getElementById('saver_diary');
        var d = new Date();
        var hour=d.getHours(); //获取小时   
        var minutes=d.getMinutes(); //获取分钟   
        var second=d.getSeconds(); //获取秒 
        saver_sum_diary =saver_sum_diary+"     时间："+ hour+"-"+minutes+"-"+second+"      经度:" + lag_+"      纬度:" + lat_+"\n";
        tObj.value = saver_sum_diary;
        
      }
      else {
        NavSatFix_GPS.latitude = 9999;
        NavSatFix_GPS.longitude = 9999;
        NavSatFix_GPS.altitude = 9999;
      }
      ints++;
      var myDate = new Date();
      NavSatFix_GPS.header.frame_id = myDate.getSeconds().toString();
      NavSatFix_GPS_Array.datas.push(NavSatFix_GPS);

    }
    // getLocation();
    ////////////////////////////////////////////////
    var timer = null;

    function start_timer_record_gps_datas() {
      NavSatFix_GPS_Array.datas = [];
      timer = setInterval(function ()   //开启循环：每秒出现一次提示框
      {
        gps_data_array = [];
        getLocation_for_gps_array();
        //console.log("ooooooooooooooooooooooooooooooooooooooooooooooo");
      }, 2000);
    }


    /////////////////////////////////////////////////////////

    function asisstant_sweep() {
      clearInterval(timer);        //关闭循环
      Nav_gps_array_pub.publish(NavSatFix_GPS_Array);//发布消息
    }

    ///////////////////////////////////////////////////////


    function call_press() {
      if (confirm("你确定要招手吗？")) {
        getLocation();
      }
      //location.replace(document.referrer);
    }
    function sweep_press() {
      if (confirm("你确定开始清扫作业吗？")) {
        start_timer_record_gps_datas();
      }
      //location.replace(document.referrer);
    }
    function asisstant_sweep_press() {
      if (confirm("你确定要协作清扫吗？")) {
        asisstant_sweep();
      }
      //location.replace(document.referrer);
    }

    function warn_() {
      if (confirm("是否打开吸扫运程控制？")) {
        var code = prompt("请输入管理员密码")
        if (code != 123456) {
          alert("密码错误！");
          window.location.href = "../tool.html"
        }
      }
    }
    //warn_();




  </script>


<body>
  <div style="margin-left:20%;padding:1px 16px;height:1000px;overflow:hidden;">

    <div class="srv_state">
      <p id="connect_status">服务器状态（未响应）</p>

    </div>

    <title>吸扫运程控制</title>
    <h1 id="license">阳光无人车</h1>

    <script language="javascript">
      LICENSE = '吸扫运程控制：' + LICENSE;
      document.getElementById("license").innerHTML = LICENSE;
    </script>

    <div>
      <br /><br />
      </p>
    </div>

    <button onclick="call_press()" style="width:200px;">&nbsp; 召唤 &nbsp;</button>&nbsp;&nbsp;
    <button onclick="sweep_press()" style="width:200px;">&nbsp; 清扫作业 &nbsp;</button>&nbsp;&nbsp;
    <button onclick="asisstant_sweep_press()" style="width:200px;">&nbsp; 协作清扫 &nbsp;</button>&nbsp;&nbsp;

    <div></div>
    <br /><br /><br /><br />
    <textarea id="saver_diary"rows="60" cols="80" readonly="readonly"></textarea>




    <script language="javascript">
      // // Subscribing to a Topic  velocity
      // var listener_velocity = new ROSLIB.Topic({
      //   ros: ros,
      //   name: '/cti/fpga_serial/ctlrun_info',
      //   messageType: 'cti_msgs/VehicleCtlRunInfo'
      // });
  
      //listener_velocity.subscribe(function (message) {
  
      //   if(flag_record == 1)
      //   {
      //     if(count > 2)
      //     {
      //       var tObj = document.getElementById('saver_diary');
      //       var d = new Date();
      //       var hour=d.getHours(); //获取小时   
      //       var minutes=d.getMinutes(); //获取分钟   
      //       var second=d.getSeconds(); //获取秒 
      //       saver_sum_diary =saver_sum_diary+"     时间："+ hour+"-"+minutes+"-"+second+"      速度:" + message.vel_liner_x+"\n";
      //       tObj.value = saver_sum_diary;
      //       count = 0;
      //     }
      //     else
      //     {
      //       count++;
      //     }
      // }
      //}); 
    </script>

  </div>
  <!-- <div class="icon" >
  <img src="image/002.png" class="icon" width="400px" height="350px" style="z-index: -1;"/>
  </div> -->

</body>

</html>
