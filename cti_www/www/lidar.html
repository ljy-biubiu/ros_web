<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <!-- <meta http-equiv="refresh" content="0.1"> content 为间隔时间 -->
  <script type="text/javascript"
    src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script src="js/roslibjs/roslib.js"></script>
  <script src="js/design/WEB_PARAM.js"></script>
  <script src="js/design/project_name.js"></script>
  <script src="js/design/CodeToNavigation.js"></script>
  <script src="js/design/project_name.js"></script>
  <script src="js/design/BOX_message.js"></script>
  <script src="js/design/cloud_toChinese.js"></script>


  <link rel="stylesheet" type="text/css" href="css/style.css">

  <script type="text/javascript" type="text/javascript">

    // Connecting to ROS
    var ros = new ROSLIB.Ros({
      url: IP_PORT
    });

    var color = '#99bebe ';
    var style;

    function createStyle() {
      style = document.createElement('style');
      style.type = 'text/css';
    }
    function changeBackgroundColor() {
      if (!style.parentNode) document.head.appendChild(style);
    }
    createStyle();
    changeBackgroundColor();
    
    function changeColor() {
      var color = "yellow|green|blue";
      color = color.split("|");
      document.getElementById("connect_status").style.color = color[parseInt(Math.random() * color.length)];
    }

    //判断是否连接成功并输出相应的提示消息到web控制台
    ros.on('connection', function () {
      document.getElementById("connect_status").innerHTML = ('服务器状态（正常）');
      style.innerHTML = 'body {background-color: #bebfc0 ;}';
    });

    ros.on('error', function (error) {
      document.getElementById("connect_status").innerHTML = ('服务器状态（错误）');
      style.innerHTML = 'body {background-color: #4f5257  ;}';
    });

    ros.on('close', function () {
      document.getElementById("connect_status").innerHTML = ('服务器状态（关闭）');
      style.innerHTML = 'body {background-color: #4f5257  ;}';
      alert("服务器连接中断，请检查wifi状态，并刷新当前页面");
    });



    // function changeColor() {
    //   var color = "yellow|green|blue";
    //   color = color.split("|");
    //   document.getElementById("connect_status").style.color = color[parseInt(Math.random() * color.length)];
    // }

    // setInterval("changeColor()", 500);

    ///////////////////////////////////////////////////////

    // Subscribing to a Topic
    var box_movable_msg = new ROSLIB.Topic({
      ros: ros,
      name: '/box_assemble/movable_state',
      messageType: 'cti_msgs/State'
    });


    box_movable_msg.subscribe(function (message) {

      document.getElementById("BOX_state").innerHTML = message.header.frame_id;

    });

    ///////////////////////////////////////////////////////

    // Subscribing to a Topic
    var listener_ = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/cti_mapsample/mapToPng_encodebase64_topic',
      messageType: 'std_msgs/String'
    });

    listener_.subscribe(function (message) {

      var ima = document.getElementById("tus");
      ima.src = message.data

    });
    ///////////////////////////////////////////////////////前方施工
    // Publishing a Topic
    var cmd_pub = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/rosweb/cmd_lidar',
      messageType: 'std_msgs/Int32'
    });

    var command = new ROSLIB.Message({
      data: 0
    });//创建一个message
    function send_command(message) {
      command.data = message;
      cmd_pub.publish(command);//发布消息
    }

    function turn_to_coordination_model() {
      send_command(1);         //请求初始地图
      window.location.href = "lidar _coordination.html"
    }

    send_command(0);         //请求初始地图

    //////////////////////////////////////////////////////////////////////////////////

    // Subscribing to a Topic
    var listener_led_navi_code = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/led/navigation_msg',
      messageType: 'std_msgs/String'
    });

    listener_led_navi_code.subscribe(function (message) {
      for (var i = 0; i < json2.length; i++) {
        if (json2[i].code == message.data) {
          document.getElementById("blink").innerHTML = json2[i].msg;
        }
      }
    });

    console.log("------------------------");
    console.log("------------------------");
    console.log("------------------------");
    console.log("------------------------");
    console.log("------------------------");
    console.log(json2.length);

    // Subscribing to a Topic  project
    var listener_project = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/robot_env',
      messageType: 'std_msgs/String'
    });

    listener_project.subscribe(function (message) {
      var flag = 0;
      for (var i = 0; i < project_name.length; i++) {
        if (project_name[i].code == message.data) {
          flag = 1;
          document.getElementById("project").innerHTML = project_name[i].name;
          path = "pcd/" + project_name[i].name + ".pcd";
          console.log(path);
        }
      }
      if (flag == 0) {
        document.getElementById("project").innerHTML = message.data;
      }
    });

    // Subscribing to a Topic  velocity
    var listener_velocity = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/fpga_serial/ctlrun_info',
      messageType: 'cti_msgs/VehicleCtlRunInfo'
    });

    listener_velocity.subscribe(function (message) {
      document.getElementById("velocity").innerHTML = message.vel_liner_x.toFixed(3);
      document.getElementById("odometer").innerHTML = message.odometer.toFixed(3);
    });


    // Subscribing to a Topic
    var box_msg = new ROSLIB.Topic({
      ros: ros,
      name: 'cti/web/box_msg',
      messageType: 'std_msgs/String'
    });


    box_msg.subscribe(function (message) {
      var obj_box_json = JSON.parse(message.data)
      for (var i = 0; i < obj_box_json.length; i++) {
        var s1 = String(i);
        var s2 = '_qr';
        var s3 = '_hive_type';
        var s4 = '_hive_device_type'
        var s5 = '_position'
        document.getElementById(s1.concat(s2)).innerHTML = obj_box_json[i].qr;
        document.getElementById(s1.concat(s5)).innerHTML = obj_box_json[i].position;
        for (var j = 0; j < box_type.length; j++) {
          if (obj_box_json[i].hive_type == box_type[j].code) {
            document.getElementById(s1.concat(s3)).innerHTML = box_type[j].name;
          }
        }
        for (var j = 0; j < device_type.length; j++) {
          if (obj_box_json[i].hive_device_type == device_type[j].code) {
            document.getElementById(s1.concat(s4)).innerHTML = device_type[j].name;
          }
        }
      }
    });

    //////////////////////////////////////////////////aaa
    // Subscribing to a Topic
    var listener_web_diary = new ROSLIB.Topic({
      ros: ros,
      name: 'cti/web/diary',
      messageType: 'std_msgs/String'
    });

    var to_document_link = "document.html";
    listener_web_diary.subscribe(function (message) {
      var json = JSON.parse(message.data);

      document.getElementById("nav_message").innerHTML = json[json.length - 1].message;
      document.getElementById("nav_code").innerHTML = json[json.length - 1].error_code;
      to_document_link = "document.html#" + json[json.length - 1].error_code;
      console.log(to_document_link);
      if (json[json.length - 1].message == "信息：恢复正常" || json[json.length - 1].message == "------开机------") {
        document.getElementById("nav_message").innerHTML = "无";
        document.getElementById("nav_code").innerHTML = "无";
        to_document_link = "document.html";
      }
    }
    )

    // Subscribing to a Topic
    var cloud_msg = new ROSLIB.Topic({
      ros: ros,
      name: 'cti/web/NavDeliveryResp',
      messageType: 'std_msgs/String'
    });


    cloud_msg.subscribe(function (message) {
      console.log(message);
      var obj_box_json = JSON.parse(message.data);
      var flag1 = 0;
      var flag2 = 0;
      console.log(Cloud_status);
      console.log(obj_box_json);
      for (var i = 0; i < Cloud_order.length; i++) {
        if (obj_box_json[0].command_type == Cloud_order[i].code) {
          document.getElementById("cloud_command_type").innerHTML = Cloud_order[i].name;
          flag1 = 1;
        }
      }
      if (flag1 == 0)                                                                            //找不到对应的就发送原文
      {
        document.getElementById("cloud_command_type").innerHTML = obj_box_json[0].command_type;
      }

      for (var i = 0; i < Cloud_status.length; i++) {
        if (obj_box_json[0].command_state == Cloud_status[i].code) {
          document.getElementById("cloud_command_state").innerHTML = Cloud_status[i].name;
          flag2 = 1;
        }
      }
      if (flag2 == 0) {
        document.getElementById("cloud_command_state").innerHTML = obj_box_json[0].command_state;
      }

      document.getElementById("cloud_message").innerHTML = obj_box_json[0].message;
      document.getElementById("cloud_code").innerHTML = obj_box_json[0].code;
    });


    // Subscribing to a Topic
    var nav_version = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/web/nav_version',
      messageType: 'std_msgs/String'
    });


    nav_version.subscribe(function (message) {
      document.getElementById("nav_version").innerHTML = message.data;
    })


    function changeColor() {
      var color = "yellow|green|blue";
      color = color.split("|");
      document.getElementById("velocity").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("blink").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("project").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("cloud_message").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("cloud_code").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("cloud_command_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("cloud_command_state").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("cloud_code").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("nav_version").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("odometer").style.color = color[parseInt(Math.random() * color.length)];

      document.getElementById("0_qr").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("0_hive_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("0_hive_device_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("0_position").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("1_qr").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("1_hive_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("1_hive_device_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("1_position").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("2_qr").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("2_hive_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("2_hive_device_type").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("2_position").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("BOX_state").style.color = color[parseInt(Math.random() * color.length)];

      document.getElementById("nav_message").style.color = color[parseInt(Math.random() * color.length)];
      document.getElementById("nav_code").style.color = color[parseInt(Math.random() * color.length)];

      document.getElementById("connect_status").style.color = color[parseInt(Math.random() * color.length)];

    }

    setInterval("changeColor()", 500);


    ////////////////////////////////////////////////////////////////////
    var red_err_monit_ = new ROSLIB.Topic({
      ros: ros,
      name: '/cti/web/red_err_monitor',
      messageType: 'std_msgs/Bool'
    });

    red_err_monit_.subscribe(function (message) {
      if (message.data == true) {
        err_red_control("red")
      }
      else if (message.data == false) {
        err_red_control("black")
      }
    });

    function err_red_control(color) {
      if (color == "red") {
        setTimeout(function () {
          document.getElementById("ul_vehicle").style.color = "red";
        }, 50);
        return;
      }
      else if (color == "black") {
        setTimeout(function () {
          document.getElementById("ul_vehicle").style.color = "black";
        }, 50);

      }
    }
    ////////////////////////////////////////////////////////////////////////



  </script>

  <!-- <script language="javascript">
  function changeColor() {
    var color = "#f00|#0f0|#00f|#880|#808|#088|yellow|green|blue|gray";
    color = color.split("|");
    document.getElementById("blink").style.color = color[parseInt(Math.random() * color.length)];
  }
  setInterval("changeColor()", 500);
  </script> -->

<body>
  <ul>
    <strong>
      <li><a class="title_left" href="vihicle.html" id="ul_vehicle">车辆状态</a></li>
      <li><a class="title_left" href="#home">导航状态</a></li>
      <li><a class="title_left" href="equitment.html">底盘状态</a></li>
      <li><a class="title_left" href="diary.html">错误日志</a></li>
      <li><a class="title_left" href="tool.html">其他工具</a></li>
    </strong>
  </ul>

  <div style="margin-left:20%;padding:1px 16px;height:1000px;">

    <div class="srv_state">
      <p id="connect_status">服务器状态（未响应）</p>
    </div>

    <title>阳光无人车</title>
    <h1 id="license">阳光无人车</h1>


    <script>
      LICENSE = '阳光无人车' + LICENSE;
      document.getElementById("license").innerHTML = LICENSE;
    </script>

    <br /><br />
    <p class="inline">
    <h4 class="inline">项目名称：</h4>
    <p id="project" class="inline">无</p>
    <h4 class="inline">&nbsp导航版本：</h4>
    <p id="nav_version" class="inline">无</p>
    <h4 class="inline">&nbsp导航状态：</h4>
    <p id="blink" class="inline">无</p>
    <h4 class="inline">&nbsp当前车速：</h4>
    <p id="velocity" class="inline">无</p>
    <h4 class="inline">&nbsp里程计：</h4>
    <p id="odometer" class="inline">无</p>
    <h4 class="inline">&nbsp车箱状态：</h4>
    <p id="BOX_state" class="inline">无</p>
    </p>

    <p class="inline">
    <h4 class="inline">指令类型:</h4>
    <p id="cloud_command_type" class="inline">无</p>
    <h4 class="inline">&nbsp指令状态：</h4>
    <p id="cloud_command_state" class="inline">无</p>
    <h4 class="inline">&nbsp平台错误码：</h4>
    <p id="cloud_code" class="inline">无</p>
    <h4 class="inline">&nbsp平台错误信息：</h4>
    <p id="cloud_message" class="inline">无</p>
    <h4 class="inline">&nbsp导航错误码：</h4>
    <p class="inline"><a href="#" onclick="location.href = to_document_link;" id="nav_code"></a></p>
    <h4 class="inline">&nbsp导航错误信息：</h4>
    <p id="nav_message" class="inline">无</p>
    </p>

    <!-- <td width="5%"><a href="#" onclick="location.href=ssa;" id = "errorCode_0" >无</a></td>"document.html#顶升" -->

    <body>
      <div align="center">
        <img id="tus" src="image/lidar_ma.png" class="lidar" width="600px" height="900px">
      </div>
    </body>
    <p class="inline">
    <h5 id="license">箱体信息:</h5>
    </p>
    <p class="inline">
    <h4 class="inline">二维码:</h4>
    <p id="0_qr" class="inline">无</p>
    <h4 class="inline">&nbsp箱子类型：</h4>
    <p id="0_hive_type" class="inline">无</p>
    <h4 class="inline">&nbsp装置类型：</h4>
    <p id="0_hive_device_type" class="inline">无</p>
    <h4 class="inline">&nbsp放置位置：</h4>
    <p id="0_position" class="inline">无</p>
    </p>
    <p class="inline">
    <h4 class="inline">二维码:</h4>
    <p id="1_qr" class="inline">无</p>
    <h4 class="inline">&nbsp箱子类型：</h4>
    <p id="1_hive_type" class="inline">无</p>
    <h4 class="inline">&nbsp装置类型：</h4>
    <p id="1_hive_device_type" class="inline">无</p>
    <h4 class="inline">&nbsp放置位置：</h4>
    <p id="1_position" class="inline">无</p>
    </p>
    <p class="inline">
    <h4 class="inline">二维码:</h4>
    <p id="2_qr" class="inline">无</p>
    <h4 class="inline">&nbsp箱子类型：</h4>
    <p id="2_hive_type" class="inline">无</p>
    <h4 class="inline">&nbsp装置类型：</h4>
    <p id="2_hive_device_type" class="inline">无</p>
    <h4 class="inline">&nbsp放置位置：</h4>
    <p id="2_position" class="inline">无</p>
    </p>
  </div>
  <!-- <button onclick="stop()" style="width:800px;">停止</button> -->
  <div class="icon">
    <img src="image/123.png" class="icon" width="200px" height="175px" style="z-index: -1;" />
  </div>
  <!-- <div class="icon" >
  <img src="image/002.png" class="icon" width="400px" height="350px" style="z-index: -2;"/>
  </div> -->
  <!-- <br /><br /><br /> -->
  <iframe src="vihicle.html" width="0" height="0"></iframe>
</body>

</html>